<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>hehe PDF</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <style>
    .btn-gradient { background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%); }
    .custom-scrollbar::-webkit-scrollbar { width: 5px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 10px; }
    .loader { border-top-color: #4F46E5; animation: spinner 1.5s linear infinite; }
    @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .page-card { transition: all 0.2s; cursor: grab; }
    .page-card:active { cursor: grabbing; }
    .page-thumb { width: 100%; aspect-ratio: 3/4; object-fit: contain; background: white; border-radius: 12px; box-shadow: inset 0 0 10px rgba(0,0,0,0.05); }
    .tab-active { border-bottom: 3px solid #6366f1; color: #6366f1; font-weight: bold; }
    
    /* Efek visual pas file ditarik ke layar */
    .drag-over-active { background-color: #EEF2FF !important; border: 4px dashed #6366f1 !important; }
  </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900 font-sans transition-colors duration-300" id="drop-area-global">

  <nav class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b border-slate-200 p-4">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div class="flex items-center gap-2">
        <div class="bg-indigo-600 p-2 rounded-xl shadow-lg shadow-indigo-200"><i class="fas fa-file-pdf text-white"></i></div>
        <h1 class="text-xl font-black tracking-tighter">hehe<span class="text-indigo-600">PDF</span></h1>
      </div>
      <div id="status-badge" class="px-3 py-1 rounded-full bg-slate-100 text-[10px] font-black text-slate-500 uppercase tracking-widest">hehehe</div>
    </div>
  </nav>

  <main class="max-w-[1600px] mx-auto p-4 lg:p-8">
    <div class="flex flex-col lg:flex-row gap-8">
      
      <div class="w-full lg:w-80 shrink-0 space-y-6">
        <div class="bg-white rounded-[2.5rem] shadow-sm border border-slate-200 overflow-hidden sticky top-28">
          <div class="flex border-b border-slate-100">
            <button onclick="switchTab('sheet')" id="tab-sheet" class="flex-1 py-5 text-[10px] font-black uppercase tracking-[0.2em] tab-active">Database</button>
            <button onclick="switchTab('local')" id="tab-local" class="flex-1 py-5 text-[10px] font-black uppercase tracking-[0.2em] text-slate-400">Upload</button>
          </div>

          <div id="content-sheet" class="p-5 space-y-4">
            <input type="text" id="searchData" onkeyup="filterList()" placeholder="Cari rincian..." class="w-full p-3 bg-slate-50 rounded-2xl text-xs border-none ring-1 ring-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none transition">
            <button onclick="loadSheetData()" class="w-full py-3 bg-indigo-50 text-indigo-600 rounded-2xl text-[10px] font-black hover:bg-indigo-100 transition uppercase tracking-widest"><i class="fas fa-sync-alt mr-2"></i>Refresh Data</button>
            <div id="history-list" class="h-[450px] overflow-y-auto custom-scrollbar space-y-2 pr-1"></div>
          </div>

          <div id="content-local" class="hidden p-6">
            <div id="drop-zone" onclick="document.getElementById('fileInput').click()" class="border-2 border-dashed border-slate-200 rounded-[2rem] p-10 text-center hover:bg-indigo-50 transition cursor-pointer group">
              <input type="file" id="fileInput" class="hidden" multiple onchange="handleLocalFiles(this.files)">
              <i class="fas fa-plus-circle text-3xl text-slate-300 group-hover:text-indigo-500 mb-3"></i>
              <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Pilih File</p>
            </div>
          </div>
        </div>
      </div>

      <div class="flex-1">
        <div id="main-workspace" class="bg-white min-h-[85vh] rounded-[3rem] shadow-xl border border-slate-100 p-6 lg:p-10 transition-all duration-300">
          <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-6 border-b border-slate-50 pb-8">
            <div>
              <h2 class="text-3xl font-black tracking-tighter text-slate-800">Workspace Editor</h2>
              <p class="text-[10px] text-slate-400 font-bold uppercase tracking-[0.3em] mt-2">Status: <span id="page-count" class="text-indigo-600">0</span> Halaman Terdeteksi</p>
            </div>
            <div class="flex gap-4 w-full md:w-auto">
              <button onclick="clearWorkspace()" class="flex-1 md:flex-none px-8 py-4 rounded-2xl text-[10px] font-black text-red-500 bg-red-50 hover:bg-red-100 transition uppercase tracking-widest">Reset</button>
              <button onclick="processFinalPdf()" class="flex-1 md:flex-none btn-gradient text-white px-10 py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest shadow-xl shadow-indigo-200 active:scale-95 transition">Download PDF</button>
            </div>
          </div>

          <div id="page-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 xl:grid-cols-5 gap-8"></div>
          
          <div id="empty-state" class="flex flex-col items-center justify-center py-40 text-slate-300">
             <div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mb-6">
                <i class="far fa-file-pdf text-4xl opacity-20"></i>
             </div>
             <p class="text-[10px] font-black uppercase tracking-[0.3em]">Drag file ke sini untuk mulai</p>
          </div>
        </div>
      </div>

    </div>
  </main>

  <div id="loader-overlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] hidden flex items-center justify-center">
    <div class="bg-white p-12 rounded-[3.5rem] text-center shadow-2xl">
      <div class="loader rounded-full border-4 border-t-4 border-slate-100 h-16 w-16 mb-6 mx-auto"></div>
      <p id="loader-text" class="text-[10px] font-black text-slate-800 tracking-[0.2em] uppercase">Sabar bro...</p>
    </div>
  </div>
  
<div id="rename-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[110] hidden flex items-center justify-center">
  <div class="bg-white p-8 rounded-[2.5rem] w-[400px] text-center shadow-2xl transform transition-all scale-100">
    <div class="w-16 h-16 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4">
      <i class="fas fa-edit text-xl"></i>
    </div>
    <h3 class="text-lg font-black text-slate-800 mb-2 uppercase tracking-tight">Beri Nama File</h3>
    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-6">Mau disimpan sebagai apa nih?</p>
    
    <input type="text" id="new-filename" class="w-full p-4 bg-slate-50 rounded-2xl text-sm border-none ring-2 ring-slate-100 focus:ring-indigo-500 outline-none transition mb-6 text-center font-bold" placeholder="Nama file...">
    
    <div class="flex gap-3">
      <button onclick="closeRenameModal()" class="flex-1 py-4 rounded-xl text-[10px] font-black text-slate-400 bg-slate-100 hover:bg-slate-200 transition uppercase tracking-widest">Batal</button>
      <button onclick="confirmDownload()" class="flex-1 py-4 rounded-xl text-[10px] font-black text-white btn-gradient shadow-lg shadow-indigo-200 uppercase tracking-widest">Download</button>
    </div>
  </div>
</div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxsVIYFkTWzjokXL1feB3_IxsI94egsoH2UdY9_nczW1LbEKe-U58pLNgKaaS-r1JPPHQ/exec";
    const { PDFDocument } = PDFLib;
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    
    let pageList = []; 

    // --- FITUR BARU: GLOBAL DRAG N DROP FILE LOKAL ---
    const dropArea = document.getElementById('main-workspace');

    // Mencegah browser buka file otomatis
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      window.addEventListener(eventName, e => {
        e.preventDefault();
        e.stopPropagation();
      }, false);
    });

    // Efek visual pas file melayang di atas workspace
    window.addEventListener('dragover', () => {
      dropArea.classList.add('drag-over-active');
    });

    window.addEventListener('dragleave', () => {
      dropArea.classList.remove('drag-over-active');
    });

    // Eksekusi pas file dilepas
    window.addEventListener('drop', (e) => {
      dropArea.classList.remove('drag-over-active');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleLocalFiles(files);
      }
    });

    function switchTab(t) {
      document.getElementById('content-sheet').classList.toggle('hidden', t !== 'sheet');
      document.getElementById('content-local').classList.toggle('hidden', t !== 'local');
      document.getElementById('tab-sheet').className = t === 'sheet' ? 'flex-1 py-5 text-[10px] font-black uppercase tracking-[0.2em] tab-active' : 'flex-1 py-5 text-[10px] font-black uppercase tracking-[0.2em] text-slate-400';
      document.getElementById('tab-local').className = t === 'local' ? 'flex-1 py-5 text-[10px] font-black uppercase tracking-[0.2em] tab-active' : 'flex-1 py-5 text-[10px] font-black uppercase tracking-[0.2em] text-slate-400';
    }

    async function handleLocalFiles(files) {
      toggleLoader(true, "MEMBEDAH FILE...");
      for (const file of files) {
        const buffer = await file.arrayBuffer();
        if (file.type === 'application/pdf') {
          await explodePdf(buffer, file.name);
        } else if (file.type.startsWith('image/')) {
          pageList.push({ buffer: buffer, sourceName: file.name, type: 'image', mime: file.type });
        }
      }
      renderAllPages();
      toggleLoader(false);
    }

    async function addFromSheet(url, name) {
      toggleLoader(true, "MENGAMBIL DRIVE...");
      try {
        const res = await fetch(`${GAS_URL}?action=getFileData&id=${encodeURIComponent(url)}`);
        const data = await res.json();
        if(!data.success) throw new Error(data.error);
        
        const binaryString = atob(data.data);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
        const buffer = bytes.buffer;

        if (data.mimeType === 'application/pdf') {
          await explodePdf(buffer, name);
        } else if (data.mimeType.startsWith('image/')) {
          pageList.push({ buffer: buffer, sourceName: name || data.name, type: 'image', mime: data.mimeType });
        }
        renderAllPages();
      } catch(e) { 
        console.error(e);
        alert("Gagal load dari Drive: " + e.message); 
      }
      toggleLoader(false);
    }

    async function explodePdf(arrayBuffer, fileName) {
      const pdf = await pdfjsLib.getDocument({data: arrayBuffer.slice(0)}).promise;
      for (let i = 1; i <= pdf.numPages; i++) {
        pageList.push({
          buffer: arrayBuffer.slice(0),
          pageIndex: i - 1,
          sourceName: fileName,
          type: 'pdf'
        });
      }
    }

    function renderAllPages() {
      const grid = document.getElementById('page-grid');
      grid.innerHTML = '';
      
      if(pageList.length === 0) {
        document.getElementById('empty-state').classList.remove('hidden');
        document.getElementById('page-count').innerText = "0";
        return;
      }
      document.getElementById('empty-state').classList.add('hidden');
      document.getElementById('page-count').innerText = pageList.length;

      pageList.forEach((item, i) => {
        const card = document.createElement('div');
        card.dataset.id = i; 
        card.className = "page-card group relative bg-white p-3 rounded-[2rem] border border-slate-200 shadow-sm hover:shadow-xl transition-all";
        
        card.innerHTML = `
          <div class="relative mb-4">
            <canvas id="canvas-${i}" class="page-thumb shadow-sm"></canvas>
            <button onclick="removePage(${i}, event)" class="absolute -top-2 -right-2 bg-red-500 text-white w-8 h-8 rounded-full shadow-lg opacity-0 group-hover:opacity-100 transition flex items-center justify-center hover:scale-110">
              <i class="fas fa-times text-xs"></i>
            </button>
          </div>
          <div class="flex justify-between items-center px-2">
            <div class="bg-indigo-600 text-white w-5 h-5 rounded-lg flex items-center justify-center text-[9px] font-black page-num">${i + 1}</div>
            <p class="text-[8px] font-black text-slate-400 uppercase truncate w-24 text-right">${item.sourceName}</p>
          </div>
        `;
        grid.appendChild(card);
        
        if(item.type === 'pdf') renderPdfPage(item.buffer.slice(0), item.pageIndex, `canvas-${i}`);
        else renderImgPage(item.buffer, item.mime, `canvas-${i}`);
      });
      
      // Re-init Sortable tiap kali render agar urutan tetap sync
      initSortable();
    }

    function initSortable() {
      const grid = document.getElementById('page-grid');
      Sortable.create(grid, {
        animation: 250,
        onEnd: (evt) => {
          const movedItem = pageList.splice(evt.oldIndex, 1)[0];
          pageList.splice(evt.newIndex, 0, movedItem);
          renderAllPages(); 
        }
      });
    }

    async function renderPdfPage(buffer, idx, cid) {
      try {
        const pdf = await pdfjsLib.getDocument({data: buffer}).promise;
        const page = await pdf.getPage(idx + 1);
        const canvas = document.getElementById(cid);
        const ctx = canvas.getContext('2d');
        const viewport = page.getViewport({ scale: 0.5 });
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        await page.render({ canvasContext: ctx, viewport }).promise;
      } catch (e) { console.error("Render Error:", e); }
    }

    function renderImgPage(buffer, mime, cid) {
      const canvas = document.getElementById(cid);
      const ctx = canvas.getContext('2d');
      const blob = new Blob([buffer], {type: mime});
      const img = new Image();
      img.onload = () => {
        canvas.width = 300; canvas.height = 400;
        ctx.drawImage(img, 0, 0, 300, 400);
      };
      img.src = URL.createObjectURL(blob);
    }

    function removePage(i, event) {
      if (event) event.stopPropagation();
      pageList.splice(i, 1);
      renderAllPages();
    }

    function clearWorkspace() {
      if(confirm("Hapus semua?")) {
        pageList = [];
        renderAllPages();
      }
    }

function processFinalPdf() {
  if (pageList.length === 0) return alert("Kosong bro!");
  const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
  const inputField = document.getElementById('new-filename');
  inputField.value = `hehe_pdf_${date}`;
  document.getElementById('rename-modal').classList.remove('hidden');
  setTimeout(() => inputField.select(), 50);
}

document.getElementById('new-filename').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') confirmDownload();
});

function closeRenameModal() {
  document.getElementById('rename-modal').classList.add('hidden');
}

async function confirmDownload() {
  const fileName = document.getElementById('new-filename').value || "DOKUMEN";
  closeRenameModal();
  toggleLoader(true, "MERAKIT PDF...");
  try {
    const finalPdf = await PDFDocument.create();
    for (const item of pageList) {
      if (item.type === 'pdf') {
        const srcPdf = await PDFDocument.load(item.buffer.slice(0));
        const [copiedPage] = await finalPdf.copyPages(srcPdf, [item.pageIndex]);
        finalPdf.addPage(copiedPage);
      } else {
        const img = item.mime === 'image/png' ? await finalPdf.embedPng(item.buffer) : await finalPdf.embedJpg(item.buffer);
        const page = finalPdf.addPage([595, 842]);
        const { width, height } = img.scale(1);
        const ratio = Math.min(575 / width, 822 / height);
        page.drawImage(img, { x: (595 - width * ratio) / 2, y: (842 - height * ratio) / 2, width: width * ratio, height: height * ratio });
      }
    }
    const pdfBytes = await finalPdf.save();
    const link = document.createElement('a');
    link.href = URL.createObjectURL(new Blob([pdfBytes], { type: "application/pdf" }));
    link.download = `${fileName}.pdf`;
    link.click();
  } catch (e) { alert(e.message); }
  toggleLoader(false);
}

    async function loadSheetData() {
      const list = document.getElementById('history-list');
      list.innerHTML = '<p class="text-center text-[10px] font-black py-10 animate-pulse text-indigo-400">LOADING DATA...</p>';
      try {
        const res = await fetch(`${GAS_URL}?action=getHistory`);
        const data = await res.json();
        list.innerHTML = data.map(item => `
          <div class="p-4 bg-white rounded-2xl border border-slate-100 flex justify-between items-center group hover:border-indigo-300 hover:shadow-lg transition-all">
            <div class="truncate mr-3">
              <p class="text-[9px] font-black uppercase text-slate-800 truncate">${item.rincian || 'Doc'}</p>
              <p class="text-[7px] font-bold text-slate-400 uppercase tracking-tighter">${item.user}</p>
            </div>
            <button onclick="addFromSheet('${item.fileUrl}', '${item.rincian}')" class="p-2.5 bg-indigo-50 text-indigo-600 rounded-xl group-hover:bg-indigo-600 group-hover:text-white transition-colors">
              <i class="fas fa-plus text-[10px]"></i>
            </button>
          </div>
        `).join('');
      } catch(e) { list.innerHTML = 'Gagal ambil data bro'; }
    }

    function toggleLoader(s, t) {
      document.getElementById('loader-overlay').classList.toggle('hidden', !s);
      document.getElementById('loader-text').innerText = t;
    }

    function filterList() {
      const q = document.getElementById('searchData').value.toLowerCase();
      document.querySelectorAll('#history-list > div').forEach(el => {
        el.style.display = el.innerText.toLowerCase().includes(q) ? 'flex' : 'none';
      });
    }
    
    window.onload = () => {
  switchTab('local');
};
  </script>
</body>
</html>
